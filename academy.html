<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy | dmichos</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
    <style>
        main {
            max-width: 1400px;
            width: 95%;
        }

        .academy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .lesson-selector {
            display: flex;
            gap: 1rem;
        }

        .selector-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            color: #888;
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            transition: 0.3s;
        }

        .selector-btn.active,
        .selector-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .terminal-fullscreen {
            background: rgba(0, 0, 0, 0.92);
            border: 1px solid var(--border-color);
            height: 600px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: inset 0 0 50px rgba(0, 255, 65, 0.01);
            overflow: hidden;
        }

        /* VIM Editor Styles */
        #vim-editor {
            display: none;
            flex-grow: 1;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            color: #ccc;
            position: relative;
        }

        .vim-line {
            display: flex;
            gap: 15px;
            height: 1.4rem;
            align-items: center;
        }

        .vim-tilde {
            color: #3579a8;
            width: 15px;
            text-align: center;
        }

        .vim-content {
            flex-grow: 1;
            color: #d1d1d1;
            font-size: 0.95rem;
        }

        .cursor-active {
            background: #fff;
            color: #000;
            display: inline-block;
            width: 9px;
            height: 1.2rem;
            animation: blink-cursor 1s step-end infinite;
        }

        @keyframes blink-cursor {
            50% {
                opacity: 0;
            }
        }

        .vim-status-bar {
            background: #2c2c2c;
            color: #fff;
            padding: 2px 10px;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            position: absolute;
            bottom: 25px;
            width: 100%;
            left: 0;
            z-index: 5;
        }

        .vim-command-line {
            height: 25px;
            background: #000;
            padding: 0 10px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            position: absolute;
            bottom: 0;
            width: 100%;
            left: 0;
            color: white;
            z-index: 5;
        }

        /* Mission Overlay */
        .mission-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(5, 5, 5, 0.95);
            border: 1px solid var(--accent-primary);
            padding: 1.5rem;
            z-index: 120;
            width: 280px;
            box-shadow: -10px 10px 30px rgba(0, 0, 0, 0.9);
            display: none;
        }

        .mission-panel.visible {
            display: block;
        }

        .mission-panel h5 {
            margin: 0 0 1rem 0;
            color: var(--accent-primary);
            font-size: 0.75rem;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .close-mission {
            cursor: pointer;
            color: #555;
            font-size: 1rem;
            transition: 0.3s;
            pointer-events: auto;
        }

        .close-mission:hover {
            color: var(--accent-primary);
        }

        .mission-text {
            margin: 0;
            color: #fff;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .objective-trigger {
            position: absolute;
            top: 20px;
            right: 140px;
            /* Positioned left of manual ref */
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
            padding: 5px 12px;
            font-size: 0.7rem;
            cursor: pointer;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            text-transform: uppercase;
        }

        /* Terminal Styles */
        .terminal-body {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
        }

        .term-input-row {
            display: flex;
            padding: 10px 20px;
            background: #080808;
            border-top: 1px solid #222;
            z-index: 10;
        }

        .prompt {
            color: var(--accent-primary);
            margin-right: 10px;
        }

        #main-input {
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            width: 100%;
        }

        .cheat-sheet-trigger {
            position: absolute;
            top: 20px;
            right: 20px;
            border: 1px solid var(--accent-secondary);
            color: var(--accent-secondary);
            padding: 5px 12px;
            font-size: 0.7rem;
            cursor: pointer;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
        }

        .overlay-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 280px;
            background: rgba(5, 5, 5, 0.95);
            border: 1px solid var(--accent-secondary);
            padding: 1.5rem;
            z-index: 120;
            display: none;
            box-shadow: -10px 10px 30px rgba(0, 0, 0, 0.9);
        }

        .overlay-panel.visible {
            display: block;
        }

        .cheat-item {
            margin-bottom: 8px;
            font-size: 0.75rem;
            color: #aaa;
        }

        .cheat-item span {
            color: var(--accent-primary);
            font-weight: bold;
            margin-right: 8px;
        }

        .mission-toast {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 255, 65, 0.2);
            border: 1px solid var(--accent-primary);
            padding: 10px 20px;
            color: var(--accent-primary);
            opacity: 0;
            transition: 0.5s;
            z-index: 200;
            font-weight: bold;
        }

        .mission-toast.visible {
            opacity: 1;
        }

        .output-block {
            color: #888;
            margin-bottom: 8px;
            border-left: 2px solid #333;
            padding-left: 10px;
            font-size: 0.85rem;
        }

        .success-text {
            color: var(--accent-primary);
            font-weight: bold;
        }

        .info-text {
            color: var(--accent-secondary);
        }

        .error-text {
            color: #ff5f56;
        }
    </style>
</head>

<body>
    <div id="particles-js"></div>
    <header>
        <nav>
            <ul>
                <li><a href="index.html">/home</a></li>
                <li><a href="about.html">/profile</a></li>
                <li><a href="projects.html">/toolshed</a></li>
                <li><a href="academy.html" class="active">/academy</a></li>
                <li><a href="contact.html">/connect</a></li>
            </ul>
        </nav>
    </header>
    <main style="max-width: 1200px;">
        <div class="terminal-window">
            <div class="terminal-header">
                <div class="dot red"></div>
                <div class="dot yellow"></div>
                <div class="dot green"></div>
                <span id="term-path"
                    style="font-size: 0.7rem; color: #555; margin-left: 10px;">dmichos@CyberSec:~/academy/vim</span>
            </div>

            <div class="academy-header">
                <h1>[ CYBER_ACADEMY ]</h1>
                <div class="lesson-selector">
                    <button class="selector-btn active" id="btn-vim" onclick="switchLesson('vim')">VIM_LAB</button>
                    <button class="selector-btn" id="btn-pwntools"
                        onclick="switchLesson('pwntools')">GDB_PWNTOOLS</button>
                </div>
            </div>

            <div class="terminal-fullscreen">
                <button class="objective-trigger" onclick="toggleMission()">[ Objective ]</button>
                <button class="cheat-sheet-trigger" onclick="toggleCheatSheet()">[ Manual_Ref ]</button>
                <div class="mission-toast" id="mission-toast">Objective Synchronized!</div>

                <!-- MISSION PANEL (Closable Popup) -->
                <div class="mission-panel" id="mission-panel">
                    <h5>
                        <span>Current Objective</span>
                        <span class="close-mission" onclick="toggleMission()">&times;</span>
                    </h5>
                    <p class="mission-text" id="mission-display">Initializing mission...</p>
                </div>

                <!-- VIM INTERFACE -->
                <div id="vim-editor">
                    <div id="vim-lines"></div>
                    <div class="vim-status-bar">
                        <span id="vim-filename">"mission.log" [New]</span>
                        <span id="vim-pos">1,1 All</span>
                    </div>
                    <div class="vim-command-line" id="vim-cmd-display"></div>
                </div>

                <!-- SHELL INTERFACE -->
                <div class="terminal-body" id="term-body">
                    <div id="term-history"></div>
                </div>

                <!-- INPUT AREA -->
                <div class="term-input-row">
                    <span class="prompt" id="term-prompt">guest@academy:~$</span>
                    <input type="text" id="main-input" autofocus autocomplete="off" spellcheck="false"
                        placeholder="Enter command...">
                </div>

                <div class="overlay-panel" id="cheat-panel">
                    <h5 id="cheat-title">VIM Reference</h5>
                    <div id="cheat-content"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const input = document.getElementById('main-input');
        const history = document.getElementById('term-history');
        const termBody = document.getElementById('term-body');
        const vimEditor = document.getElementById('vim-editor');
        const vimLines = document.getElementById('vim-lines');
        const vimCmdDisplay = document.getElementById('vim-cmd-display');
        const promptSpan = document.getElementById('term-prompt');
        const toast = document.getElementById('mission-toast');
        const cheatPanel = document.getElementById('cheat-panel');
        const cheatContent = document.getElementById('cheat-content');
        const missionDisplay = document.getElementById('mission-display');
        const pathEl = document.getElementById('term-path');

        let mode = 'shell';
        let vimSubMode = 'normal';
        let currentLesson = 'vim';
        let step = 0;
        let vimBuffer = [""];
        let currentLine = 0;

        const data = {
            vim: {
                path: "dmichos@CyberSec:~/academy/vim",
                cheat: [
                    { k: "i", d: "Insert Mode" }, { k: "Esc", d: "Normal Mode" },
                    { k: ":wq", d: "Save & Quit" }, { k: ":q!", d: "Quit (No Save)" },
                    { k: "dd", d: "Delete line" }
                ],
                missions: [
                    { q: "Open 'mission.log' with VIM.", a: "vim mission.log", type: "shell" },
                    { q: "VIM ACTIVE. Enter INSERT mode to begin logging (press 'i').", a: "i", type: "vim_mode" },
                    { q: "INSERT MODE. Type the access code 'DEPLOY_PAYLOAD' and press Enter.", a: "deploy_payload", type: "vim_write" },
                    { q: "LOGGED. Return to NORMAL mode (press 'Esc').", a: "escape", type: "vim_mode" },
                    { q: "NORMAL MODE. Type ':wq' and press Enter to save and exit.", a: ":wq", type: "vim_command" }
                ]
            },
            pwntools: {
                path: "dmichos@CyberSec:~/academy/pwntools",
                cheat: [
                    { k: "ELF('./exploit')", d: "Analyze target binary" },
                    { k: "process('./exploit')", d: "Spawn target process" },
                    { k: "p64(addr)", d: "Pack 64-bit address" },
                    { k: "sendline(data)", d: "Send data + newline" },
                    { k: "interactive()", d: "Enter interactive shell" }
                ],
                missions: [
                    { q: "Start python environment.", a: "python3", type: "shell" },
                    { q: "Import pwntools.", a: "from pwn import *", type: "python" },
                    { q: "Load target binary into 'e'.", a: "e = ELF('./exploit')", type: "python", resp: "[*] './exploit'\n    Arch:     amd64-64-little\n    RELRO:    Partial RELRO\n    Stack:    No canary found\n    NX:       NX unknown\n    PIE:      No PIE" },
                    { q: "Spawn process into 'p'.", a: "p = process('./exploit')", type: "python", resp: "[+] Starting local process './exploit': pid 1337" },
                    { q: "Craft payload with 44 bytes of padding and 'win' address (0x4011d6).", a: "payload = b'A'*44 + p64(0x4011d6)", type: "python", resp: "" },
                    { q: "Send payload to process.", a: "p.sendline(payload)", type: "python", resp: "" },
                    { q: "Go interactive to claim shell.", a: "p.interactive()", type: "python", resp: "[*] Switching to interactive mode\n$ id\nuid=1000(guest) gid=1000(guest)\n$ cat flag.txt\nPWN{P0RTF0LIO_PWN_SUCCESS}" }
                ]
            }
        };

        function renderVimScreen() {
            vimLines.innerHTML = '';
            for (let i = 0; i < 18; i++) {
                const line = document.createElement('div');
                line.className = 'vim-line';
                if (i < vimBuffer.length) {
                    let content = vimBuffer[i] || "";
                    if (vimSubMode === 'insert' && i === currentLine) {
                        content += '<span class="cursor-active">&nbsp;</span>';
                    }
                    line.innerHTML = `&nbsp;&nbsp;<div class="vim-content">${content}</div>`;
                } else {
                    line.innerHTML = `<span class="vim-tilde">~</span><div class="vim-content"></div>`;
                }
                vimLines.appendChild(line);
            }

            // Critical Feedback Fix: Ensure command line updates immediately
            if (vimSubMode === 'insert') {
                vimCmdDisplay.innerText = '-- INSERT --';
            } else if (vimSubMode === 'command') {
                vimCmdDisplay.innerText = input.value || ':';
            } else if (vimSubMode === 'normal') {
                vimCmdDisplay.innerText = '';
            }
        }

        function switchLesson(l) {
            currentLesson = l; step = 0; mode = 'shell';
            termBody.style.display = 'flex';
            vimEditor.style.display = 'none';
            promptSpan.style.visibility = 'visible';
            history.innerHTML = '';
            input.value = '';
            vimBuffer = [""];
            currentLine = 0;
            pathEl.innerText = data[l].path;

            document.querySelectorAll('.selector-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${l}`).classList.add('active');

            // Update Reference Panel Title
            const titleEl = document.getElementById('cheat-title');
            if (l === 'vim') titleEl.innerText = 'VIM Reference';
            else if (l === 'pwntools') titleEl.innerText = 'Pwntools Reference';

            cheatContent.innerHTML = data[l].cheat.map(c => `<div class="cheat-item"><span>${c.k}</span> ${c.d}</div>`).join('');

            addLine(`[SYSTEM] Initializing ${l.toUpperCase()} Lab...`, 'success-text');
            isPython = false;
            promptSpan.innerText = 'guest@academy:~$';
            document.getElementById('mission-panel').classList.add('visible');
            updateMission();
        }

        function updateMission() {
            const m = data[currentLesson].missions[step];
            if (m) {
                missionDisplay.innerText = m.q;
            } else {
                missionDisplay.innerText = "All objectives complete.";
                addLine("[SUCCESS] Mission Objectives Secured.", "success-text");
            }
        }

        let isPython = false;

        function addLine(txt, cls = '') {
            const d = document.createElement('div');
            d.className = `output-block ${cls}`;
            d.innerText = txt;
            history.appendChild(d);
            termBody.scrollTop = termBody.scrollHeight;
        }

        function success() {
            toast.className = 'mission-toast visible';
            setTimeout(() => toast.className = 'mission-toast', 2000);
            step++;
            updateMission();
        }

        function toggleCheatSheet() {
            document.getElementById('mission-panel').classList.remove('visible');
            cheatPanel.classList.toggle('visible');
        }

        function toggleMission() {
            cheatPanel.classList.remove('visible');
            document.getElementById('mission-panel').classList.toggle('visible');
        }

        input.addEventListener('input', () => {
            if (mode === 'vim') {
                if (vimSubMode === 'insert') {
                    vimBuffer[currentLine] = input.value;
                    renderVimScreen();
                } else if (vimSubMode === 'command') {
                    // Update colon display immediately
                    vimCmdDisplay.innerText = input.value;
                }
            }
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && mode === 'vim') {
                vimSubMode = 'normal';
                vimCmdDisplay.innerText = '';
                input.value = '';
                renderVimScreen();
                if (data.vim.missions[step].a === 'escape') success();
                return;
            }

            if (e.key === 'Enter') {
                const val = input.value.trim();
                const lval = val.toLowerCase();

                if (mode === 'shell') {
                    if (!val) return;
                    addLine(`${promptSpan.innerText} ${input.value}`);
                    const mission = data[currentLesson].missions[step];

                    if (lval === mission.a || val === mission.a) {
                        if (lval.startsWith('vim')) {
                            mode = 'vim'; vimSubMode = 'normal';
                            termBody.style.display = 'none';
                            vimEditor.style.display = 'block';
                            promptSpan.style.visibility = 'hidden';
                            renderVimScreen();
                        } else if (lval === 'python3') {
                            isPython = true;
                            promptSpan.innerText = '>>>';
                            addLine("Python 3.10.12 (main, Nov 20 2023) [GCC 11.4.0] on linux");
                            addLine("Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.");
                        }

                        if (mission.resp) addLine(mission.resp);
                        success();
                    } else {
                        addLine("[ERROR] INSTRUCTIONS MISMATCH. TRY AGAIN.", "error-text");
                    }
                    input.value = '';
                } else if (mode === 'vim') {
                    if (vimSubMode === 'insert') {
                        if (val === data.vim.missions[step].a) success();
                        currentLine++;
                        vimBuffer[currentLine] = "";
                        input.value = "";
                        renderVimScreen();
                    } else if (vimSubMode === 'command') {
                        // Strict check for Command Mode
                        if (input.value.trim() === data.vim.missions[step].a) {
                            mode = 'shell';
                            vimEditor.style.display = 'none';
                            termBody.style.display = 'flex';
                            promptSpan.style.visibility = 'visible';
                            success();
                        } else {
                            vimSubMode = 'normal';
                            vimCmdDisplay.innerText = '';
                        }
                        input.value = '';
                        renderVimScreen();
                    }
                }
            } else if (mode === 'vim' && vimSubMode === 'normal') {
                const key = e.key.toLowerCase();
                if (key === 'i') {
                    vimSubMode = 'insert';
                    input.value = '';
                    renderVimScreen();
                    if (data.vim.missions[step].a === 'i') success();
                    e.preventDefault();
                } else if (key === ':') {
                    vimSubMode = 'command';
                    input.value = ':';
                    renderVimScreen();
                    e.preventDefault();
                }
            }
        });

        // Init
        switchLesson('vim');
    </script>
    <script src="js/scripts.js"></script>
</body>

</html>